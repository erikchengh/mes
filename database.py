"""
完整的制药工艺数据库
涵盖所有主要制药品类
"""

class PharmaceuticalProcesses:
    """制药工艺数据库 - MES专业版"""
    
    # ====================== 原料药 (API) 生产工艺 ======================
    API_PROCESSES = {
        # 1. 化学合成API
        "化学合成原料药": {
            "抗生素类": {
                "description": "通过化学合成或半合成方法生产的抗生素原料药",
                "GMP分类": "高风险",
                "关键特征": ["抗菌谱广", "化学结构明确", "纯度要求高"],
                "工艺步骤": [
                    {"name": "反应釜投料", "关键参数": ["投料顺序", "摩尔比", "温度控制"], "设备": ["反应釜", "计量罐"], "时间(h)": 2},
                    {"name": "化学反应", "关键参数": ["反应温度", "反应时间", "pH值"], "设备": ["反应釜", "温度控制系统"], "时间(h)": 12},
                    {"name": "结晶分离", "关键参数": ["结晶温度", "搅拌速度", "结晶时间"], "设备": ["结晶罐", "离心机"], "时间(h)": 8},
                    {"name": "过滤洗涤", "关键参数": ["滤液澄清度", "洗涤溶剂", "洗涤次数"], "设备": ["过滤器", "洗涤罐"], "时间(h)": 4},
                    {"name": "干燥", "关键参数": ["干燥温度", "干燥时间", "水分含量"], "设备": ["真空干燥箱", "流化床干燥机"], "时间(h)": 10},
                    {"name": "粉碎过筛", "关键参数": ["粒度分布", "堆密度"], "设备": ["粉碎机", "振动筛"], "时间(h)": 3},
                    {"name": "混合", "关键参数": ["混合均匀度", "RSD值"], "设备": ["三维混合机"], "时间(h)": 2},
                    {"name": "包装", "关键参数": ["包装材料", "密封性"], "设备": ["包装机"], "时间(h)": 4}
                ]
            },
            
            "心血管类": {
                "description": "治疗心血管疾病的化学合成原料药",
                "GMP分类": "中高风险",
                "关键特征": ["手性中心多", "晶型控制", "稳定性要求高"],
                "工艺步骤": [
                    {"name": "不对称合成", "关键参数": ["手性选择性", "ee值", "反应收率"], "设备": ["手性反应器"], "时间(h)": 24},
                    {"name": "中间体分离", "关键参数": ["分离纯度", "回收率"], "设备": ["萃取塔", "蒸馏塔"], "时间(h)": 10},
                    {"name": "纯化精制", "关键参数": ["重结晶溶剂", "晶型控制"], "设备": ["精制罐", "结晶器"], "时间(h)": 16},
                    {"name": "干燥", "关键参数": ["晶型稳定性", "残留溶剂"], "设备": ["真空干燥器"], "时间(h)": 12},
                    {"name": "粒度控制", "关键参数": ["D50值", "粒度分布"], "设备": ["气流粉碎机"], "时间(h)": 5},
                    {"name": "包装储存", "关键参数": ["避光包装", "湿度控制"], "设备": ["铝箔袋包装机"], "时间(h)": 4}
                ]
            }
        },
        
        # 2. 生物技术API
        "生物技术原料药": {
            "重组蛋白": {
                "description": "通过重组DNA技术表达的蛋白质药物",
                "GMP分类": "极高风险",
                "关键特征": ["生物活性", "糖基化模式", "免疫原性"],
                "工艺步骤": [
                    {"name": "细胞培养", "关键参数": ["细胞密度", "活力", "代谢物"], "设备": ["生物反应器"], "时间(天)": 14},
                    {"name": "收获澄清", "关键参数": ["收获时间", "澄清度", "收率"], "设备": ["离心机", "深层过滤"], "时间(h)": 8},
                    {"name": "捕获层析", "关键参数": ["Protein A结合", "洗脱条件"], "设备": ["层析系统"], "时间(h)": 12},
                    {"name": "病毒灭活", "关键参数": ["低pH孵育", "病毒清除"], "设备": ["病毒灭活罐"], "时间(h)": 4},
                    {"name": "精细纯化", "关键参数": ["离子交换", "疏水层析"], "设备": ["层析系统"], "时间(h)": 16},
                    {"name": "超滤浓缩", "关键参数": ["浓缩倍数", "缓冲液置换"], "设备": ["切向流过滤"], "时间(h)": 6},
                    {"name": "无菌过滤", "关键参数": ["无菌保证", "完整性测试"], "设备": ["除菌过滤器"], "时间(h)": 2},
                    {"name": "冷冻干燥", "关键参数": ["冻干曲线", "水分控制"], "设备": ["冻干机"], "时间(天)": 3}
                ]
            },
            
            "单克隆抗体": {
                "description": "由杂交瘤细胞产生的特异性抗体",
                "GMP分类": "极高风险",
                "关键特征": ["高特异性", "高亲和力", "Fc功能"],
                "工艺步骤": [
                    {"name": "细胞扩增", "关键参数": ["扩增代数", "细胞状态"], "设备": ["细胞培养反应器"], "时间(天)": 10},
                    {"name": "表达生产", "关键参数": ["抗体滴度", "表达水平"], "设备": ["生产型反应器"], "时间(天)": 14},
                    {"name": "收获", "关键参数": ["收获时机", "细胞活力"], "设备": ["收获系统"], "时间(h)": 8},
                    {"name": "亲和纯化", "关键参数": ["Protein A载量", "洗脱pH"], "设备": ["Protein A层析柱"], "时间(h)": 10},
                    {"name": "低pH病毒灭活", "关键参数": ["pH值", "时间"], "设备": ["灭活罐"], "时间(h)": 2},
                    {"name": "离子交换", "关键参数": ["电荷变异体", "纯度"], "设备": ["离子交换层析"], "时间(h)": 12},
                    {"name": "纳米过滤", "关键参数": ["病毒清除", "收率"], "设备": ["病毒过滤器"], "时间(h)": 4},
                    {"name": "超滤透析", "关键参数": ["浓缩终点", "缓冲液置换"], "设备": ["切向流超滤"], "时间(h)": 8}
                ]
            }
        },
        
        # 3. 中药提取物
        "中药提取原料药": {
            "中药材提取物": {
                "description": "从天然中药材中提取的有效成分",
                "GMP分类": "中风险",
                "关键特征": ["多组分", "批次差异", "质量标准复杂"],
                "工艺步骤": [
                    {"name": "药材前处理", "关键参数": ["药材鉴定", "炮制规范"], "设备": ["洗药机", "切药机"], "时间(h)": 6},
                    {"name": "提取", "关键参数": ["溶剂选择", "提取温度", "提取次数"], "设备": ["多功能提取罐"], "时间(h)": 12},
                    {"name": "浓缩", "关键参数": ["浓缩温度", "真空度", "相对密度"], "设备": ["真空浓缩器"], "时间(h)": 8},
                    {"name": "醇沉", "关键参数": ["乙醇浓度", "沉淀时间"], "设备": ["醇沉罐"], "时间(h)": 24},
                    {"name": "柱层析纯化", "关键参数": ["吸附剂选择", "洗脱梯度"], "设备": ["层析柱系统"], "时间(h)": 16},
                    {"name": "喷雾干燥", "关键参数": ["进风温度", "出风温度", "粒度"], "设备": ["喷雾干燥塔"], "时间(h)": 6},
                    {"name": "混合包装", "关键参数": ["含量均匀性", "包装密封性"], "设备": ["混合机", "包装机"], "时间(h)": 4}
                ]
            }
        }
    }
    
    # ====================== 制剂生产工艺 ======================
    DOSAGE_FORM_PROCESSES = {
        # 1. 固体制剂
        "固体制剂": {
            "口服片剂": {
                "description": "口服固体制剂，最常见剂型",
                "GMP分类": "中风险",
                "关键特征": ["剂量准确", "稳定性好", "生物利用度适中"],
                "工艺步骤": [
                    {"name": "粉碎过筛", "关键参数": ["粒度分布", "细粉比例"], "设备": ["粉碎机", "振动筛"], "时间(h)": 4},
                    {"name": "制粒", "关键参数": ["粘合剂浓度", "终点判断"], "设备": ["湿法制粒机"], "时间(h)": 6},
                    {"name": "干燥", "关键参数": ["水分控制", "干燥终点"], "设备": ["流化床干燥机"], "时间(h)": 8},
                    {"name": "整粒总混", "关键参数": ["粒度控制", "混合均匀度"], "设备": ["整粒机", "三维混合机"], "时间(h)": 4},
                    {"name": "压片", "关键参数": ["片重差异", "硬度", "崩解时限"], "设备": ["高速压片机"], "时间(h)": 10},
                    {"name": "薄膜包衣", "关键参数": ["增重率", "包衣均匀性"], "设备": ["高效包衣锅"], "时间(h)": 6},
                    {"name": "铝塑包装", "关键参数": ["热封温度", "密封性"], "设备": ["铝塑包装机"], "时间(h)": 8},
                    {"name": "装盒", "关键参数": ["装盒准确性", "批号打印"], "设备": ["自动装盒机"], "时间(h)": 5}
                ]
            },
            
            "硬胶囊剂": {
                "description": "粉末或颗粒填充的硬胶囊制剂",
                "GMP分类": "中风险",
                "关键特征": ["掩盖不良味道", "提高稳定性", "个性化给药"],
                "工艺步骤": [
                    {"name": "内容物制备", "关键参数": ["流动性", "堆密度"], "设备": ["混合机", "制粒机"], "时间(h)": 6},
                    {"name": "胶囊填充", "关键参数": ["装量差异", "锁合完整性"], "设备": ["全自动胶囊填充机"], "时间(h)": 8},
                    {"name": "胶囊抛光", "关键参数": ["外观光洁", "除尘效果"], "设备": ["胶囊抛光机"], "时间(h)": 3},
                    {"name": "金属检测", "关键参数": ["检测灵敏度"], "设备": ["金属检测机"], "时间(h)": 4},
                    {"name": "瓶装或泡罩", "关键参数": ["装量", "密封性"], "设备": ["数粒装瓶机", "泡罩机"], "时间(h)": 7}
                ]
            }
        },
        
        # 2. 注射剂
        "注射剂": {
            "小容量注射剂": {
                "description": "装量小于50ml的注射剂",
                "GMP分类": "高风险",
                "关键特征": ["无菌保证", "无热原", "可见异物控制"],
                "工艺步骤": [
                    {"name": "浓配", "关键参数": ["活性炭用量", "吸附时间"], "设备": ["浓配罐"], "时间(h)": 4},
                    {"name": "稀配", "关键参数": ["pH调节", "含量测定"], "设备": ["稀配罐"], "时间(h)": 3},
                    {"name": "过滤除菌", "关键参数": ["滤器完整性", "无菌保证"], "设备": ["除菌过滤系统"], "时间(h)": 2},
                    {"name": "灌封", "关键参数": ["灌装精度", "封口完整性"], "设备": ["洗烘灌封联动线"], "时间(h)": 8},
                    {"name": "灭菌", "关键参数": ["F0值", "温度均匀性"], "设备": ["蒸汽灭菌柜"], "时间(h)": 3},
                    {"name": "灯检", "关键参数": ["可见异物", "安瓿外观"], "设备": ["自动灯检机"], "时间(h)": 6},
                    {"name": "贴签包装", "关键参数": ["标签信息", "包装完整性"], "设备": ["贴标机", "装盒机"], "时间(h)": 5}
                ]
            },
            
            "冻干粉针剂": {
                "description": "冷冻干燥的无菌粉末注射剂",
                "GMP分类": "极高风险",
                "关键特征": ["稳定性好", "复溶性好", "工艺复杂"],
                "工艺步骤": [
                    {"name": "配液过滤", "关键参数": ["溶解完全", "无菌过滤"], "设备": ["配液系统", "除菌过滤"], "时间(h)": 6},
                    {"name": "灌装半加塞", "关键参数": ["灌装精度", "半加塞深度"], "设备": ["灌装加塞机"], "时间(h)": 8},
                    {"name": "冷冻干燥", "关键参数": ["冻干曲线", "共晶点", "水分"], "设备": ["冻干机"], "时间(天)": 3},
                    {"name": "轧盖", "关键参数": ["轧盖密封性", "外观检查"], "设备": ["轧盖机"], "时间(h)": 4},
                    {"name": "全检包装", "关键参数": ["无菌检验", "装量差异"], "设备": ["灯检机", "包装线"], "时间(h)": 6}
                ]
            }
        },
        
        # 3. 半固体制剂
        "半固体制剂": {
            "乳膏剂": {
                "description": "O/W或W/O型乳剂基质制剂",
                "GMP分类": "中风险",
                "关键特征": ["局部外用", "释放可控", "使用舒适"],
                "工艺步骤": [
                    {"name": "油相制备", "关键参数": ["熔化温度", "均一性"], "设备": ["油相罐"], "时间(h)": 3},
                    {"name": "水相制备", "关键参数": ["溶解完全", "温度控制"], "设备": ["水相罐"], "时间(h)": 3},
                    {"name": "乳化", "关键参数": ["乳化温度", "搅拌速度"], "设备": ["真空乳化罐"], "时间(h)": 4},
                    {"name": "冷却均质", "关键参数": ["冷却速度", "均质压力"], "设备": ["冷却搅拌罐"], "时间(h)": 3},
                    {"name": "灌装", "关键参数": ["装量差异", "管尾密封"], "设备": ["乳膏灌装机"], "时间(h)": 6},
                    {"name": "包装", "关键参数": ["标签信息", "装箱规范"], "设备": ["贴标机", "装盒机"], "时间(h)": 4}
                ]
            }
        },
        
        # 4. 液体制剂
        "液体制剂": {
            "口服液": {
                "description": "口服液体制剂",
                "GMP分类": "低风险",
                "关键特征": ["吸收快", "儿童适用", "口感重要"],
                "工艺步骤": [
                    {"name": "药材提取", "关键参数": ["提取效率", "有效成分"], "设备": ["提取罐"], "时间(h)": 10},
                    {"name": "过滤浓缩", "关键参数": ["过滤精度", "浓缩程度"], "设备": ["过滤器", "浓缩器"], "时间(h)": 8},
                    {"name": "配制", "关键参数": ["pH值", "糖度", "澄清度"], "设备": ["配液罐"], "时间(h)": 6},
                    {"name": "过滤", "关键参数": ["滤液澄清", "无杂质"], "设备": ["板框过滤器"], "时间(h)": 4},
                    {"name": "灌装灭菌", "关键参数": ["装量差异", "灭菌条件"], "设备": ["液体灌装机", "灭菌柜"], "时间(h)": 8}
                ]
            }
        }
    }
    
    # ====================== 生物制品生产工艺 ======================
    BIOLOGICAL_PROCESSES = {
        # 1. 疫苗
        "疫苗": {
            "灭活疫苗": {
                "description": "病原体灭活后保留免疫原性的疫苗",
                "GMP分类": "极高风险",
                "关键特征": ["安全性高", "免疫原性好", "稳定性要求高"],
                "工艺步骤": [
                    {"name": "病毒培养", "关键参数": ["细胞基质", "病毒滴度"], "设备": ["生物反应器"], "时间(天)": 7},
                    {"name": "病毒收获", "关键参数": ["收获时机", "收获方法"], "设备": ["收获系统"], "时间(h)": 8},
                    {"name": "灭活", "关键参数": ["灭活剂", "灭活时间"], "设备": ["灭活罐"], "时间(h)": 24},
                    {"name": "纯化", "关键参数": ["纯度", "内毒素"], "设备": ["层析系统"], "时间(天)": 3},
                    {"name": "配制", "关键参数": ["抗原含量", "佐剂吸附"], "设备": ["配制罐"], "时间(h)": 12},
                    {"name": "无菌灌装", "关键参数": ["无菌操作", "灌装精度"], "设备": ["隔离器灌装线"], "时间(h)": 10}
                ]
            },
            
            "重组蛋白疫苗": {
                "description": "基因工程表达的抗原蛋白疫苗",
                "GMP分类": "极高风险",
                "关键特征": ["成分明确", "安全性好", "稳定性高"],
                "工艺步骤": [
                    {"name": "发酵表达", "关键参数": ["表达水平", "细胞密度"], "设备": ["发酵罐"], "时间(天)": 5},
                    {"name": "蛋白纯化", "关键参数": ["层析条件", "纯度"], "设备": ["层析系统"], "时间(天)": 4},
                    {"name": "病毒去除验证", "关键参数": ["病毒清除率", "验证方法"], "设备": ["病毒验证系统"], "时间(天)": 7},
                    {"name": "制剂", "关键参数": ["蛋白浓度", "稳定性"], "设备": ["制剂罐"], "时间(h)": 8}
                ]
            }
        },
        
        # 2. 血液制品
        "血液制品": {
            "人血白蛋白": {
                "description": "从人血浆中提取的白蛋白制剂",
                "GMP分类": "极高风险",
                "关键特征": ["扩容作用", "运输功能", "血源安全"],
                "工艺步骤": [
                    {"name": "血浆融冻", "关键参数": ["融冻温度", "时间"], "设备": ["融冻系统"], "时间(h)": 12},
                    {"name": "低温乙醇分离", "关键参数": ["乙醇浓度", "温度", "pH"], "设备": ["低温反应罐"], "时间(h)": 24},
                    {"name": "离心分离", "关键参数": ["离心条件", "收率"], "设备": ["连续流离心机"], "时间(h)": 8},
                    {"name": "超滤浓缩", "关键参数": ["浓缩倍数", "收率"], "设备": ["超滤系统"], "time(h)": 12},
                    {"name": "巴氏消毒", "关键参数": ["加热温度", "时间"], "设备": ["巴氏消毒柜"], "时间(h)": 10}
                ]
            }
        }
    }
    
    # ====================== 新型制剂 ======================
    NOVEL_DOSAGE_FORMS = {
        "靶向制剂": {
            "脂质体": {
                "description": "药物包封于磷脂双分子层的靶向制剂",
                "GMP分类": "高风险",
                "关键特征": ["靶向性", "缓释性", "降低毒性"],
                "工艺步骤": [
                    {"name": "脂质膜制备", "关键参数": ["磷脂组成", "成膜均匀性"], "设备": ["旋转蒸发仪"], "时间(h)": 4},
                    {"name": "水化", "关键参数": ["水化温度", "时间"], "设备": ["水化装置"], "时间(h)": 3},
                    {"name": "载药", "关键参数": ["包封率", "载药量"], "设备": ["载药系统"], "时间(h)": 6},
                    {"name": "粒径控制", "关键参数": ["挤出压力", "循环次数"], "设备": ["挤出器"], "时间(h)": 4},
                    {"name": "纯化", "关键参数": ["分离效率", "游离药物"], "设备": ["柱层析"], "时间(h)": 8}
                ]
            }
        },
        
        "透皮给药系统": {
            "透皮贴剂": {
                "description": "药物通过皮肤吸收的给药系统",
                "GMP分类": "中风险",
                "关键特征": ["避免首过效应", "血药平稳", "使用方便"],
                "工艺步骤": [
                    {"name": "药库制备", "关键参数": ["药物分散", "粘度控制"], "设备": ["混合机"], "时间(h)": 6},
                    {"name": "涂布干燥", "关键参数": ["涂布厚度", "干燥条件"], "设备": ["涂布机", "干燥隧道"], "时间(h)": 10},
                    {"name": "复合裁切", "关键参数": ["复合强度", "裁切精度"], "设备": ["复合机", "裁切机"], "时间(h)": 8},
                    {"name": "包装", "关键参数": ["包装密封", "使用说明"], "设备": ["包装机"], "时间(h)": 6}
                ]
            }
        }
    }
    
    # 合并所有工艺
    PROCESSES = {
        **API_PROCESSES,
        **DOSAGE_FORM_PROCESSES,
        **BIOLOGICAL_PROCESSES,
        **NOVEL_DOSAGE_FORMS
    }
    
    # 获取所有类别
    @staticmethod
    def get_main_categories():
        """获取所有主分类"""
        categories = []
        categories.extend(PharmaceuticalProcesses.API_PROCESSES.keys())
        categories.extend(PharmaceuticalProcesses.DOSAGE_FORM_PROCESSES.keys())
        categories.extend(PharmaceuticalProcesses.BIOLOGICAL_PROCESSES.keys())
        categories.extend(PharmaceuticalProcesses.NOVEL_DOSAGE_FORMS.keys())
        return list(set(categories))
    
    # 获取特定分类下的产品
    @staticmethod
    def get_products(category):
        """获取指定分类下的所有产品"""
        if category in PharmaceuticalProcesses.API_PROCESSES:
            return list(PharmaceuticalProcesses.API_PROCESSES[category].keys())
        elif category in PharmaceuticalProcesses.DOSAGE_FORM_PROCESSES:
            return list(PharmaceuticalProcesses.DOSAGE_FORM_PROCESSES[category].keys())
        elif category in PharmaceuticalProcesses.BIOLOGICAL_PROCESSES:
            return list(PharmaceuticalProcesses.BIOLOGICAL_PROCESSES[category].keys())
        elif category in PharmaceuticalProcesses.NOVEL_DOSAGE_FORMS:
            return list(PharmaceuticalProcesses.NOVEL_DOSAGE_FORMS[category].keys())
        else:
            return []
    
    # 获取产品信息
    @staticmethod
    def get_product_info(category, product):
        """获取特定产品的详细信息"""
        if category in PharmaceuticalProcesses.API_PROCESSES:
            return PharmaceuticalProcesses.API_PROCESSES[category].get(product, {})
        elif category in PharmaceuticalProcesses.DOSAGE_FORM_PROCESSES:
            return PharmaceuticalProcesses.DOSAGE_FORM_PROCESSES[category].get(product, {})
        elif category in PharmaceuticalProcesses.BIOLOGICAL_PROCESSES:
            return PharmaceuticalProcesses.BIOLOGICAL_PROCESSES[category].get(product, {})
        elif category in PharmaceuticalProcesses.NOVEL_DOSAGE_FORMS:
            return PharmaceuticalProcesses.NOVEL_DOSAGE_FORMS[category].get(product, {})
        else:
            return {}
    
    # 获取所有产品的统计信息
    @staticmethod
    def get_all_products_summary():
        """获取所有产品的汇总信息"""
        summary = []
        categories = PharmaceuticalProcesses.get_main_categories()
        
        for category in categories:
            products = PharmaceuticalProcesses.get_products(category)
            for product in products:
                info = PharmaceuticalProcesses.get_product_info(category, product)
                if info:
                    steps = info.get("工艺步骤", [])
                    summary.append({
                        "category": category,
                        "product": product,
                        "description": info.get("description", ""),
                        "gmp_class": info.get("GMP分类", "未分类"),
                        "steps_count": len(steps),
                        "critical_params": sum(1 for step in steps for param in step.get("关键参数", []) 
                                            if any(keyword in param for keyword in ["无菌", "病毒", "纯度", "含量"])),
                        "equipment_count": len(set(equip for step in steps for equip in step.get("设备", []))),
                        "total_time": sum(float(str(step.get("时间", "0")).replace("(h)", "").replace("(天)", "")) 
                                        for step in steps if "时间" in step)
                    })
        return pd.DataFrame(summary)
